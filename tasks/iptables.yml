---
- name: Install iptables
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - iptables-persistent

- name: Disable IPv6 globally
  lineinfile:
    line: 'net.ipv6.conf.all.disable_ipv6 = 1'
    state: present
    insertafter: EOF
    path: /etc/sysctl.conf
    mode: 0644
  notify: Activate sysctl

- name: iptables drop invalid
  iptables:
    chain: INPUT
    match: state
    ctstate: INVALID
    jump: drop
    comment: drop invalid
    action: insert
    num_rule: 1
  notify: save iptables

- name: iptables drop new TCP packets without the SYN flag
  iptables:
    chain: INPUT
    protocol: tcp
    syn: negate
    match: state
    ctstate: NEW
    jump: drop
    comment: drop new TCP packets without the SYN flag
    action: insert
    num_rule: 2
  notify: save iptables

- name: iptables drop XMAS packets
  iptables:
    chain: INPUT
    protocol: tcp
    tcp_flags:
      flags: ALL
      flag_set:
        - FIN
        - PSH
        - URG
    jump: LOG
    log_prefix: "DROPPED XMAS PACKET:"
    comment: drop XMAS packets
    action: insert
    num_rule: 3
  notify: save iptables

- name: iptables allow related and established connections
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
    comment: allow related and established connections                      
    action: insert
    num_rule: 4
  notify: save iptables

- name: iptables allow internal traffic
  iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT
    comment: allow internal traffic
  notify: save iptables

- name: iptables allow SSH port
  iptables:
    chain: INPUT
    protocol: tcp
    match: state
    ctstate: NEW
    jump: ACCEPT
    comment: allow SSH port
  notify: save iptables

- name: iptables allow ICMP ping
  iptables:
    chain: INPUT
    protocol: icmp
    icmp_type: 8
    jump: ACCEPT
    comment: allow ICMP ping
  notify: save iptables

  #- name: Set basic iptables policies
  #  iptables_raw:
  #    name: default_policies
  #    keep_unmanaged: "{{ iptables_keep_unmanaged }}"
  #    rules: "{{ iptables_policies_general }}"
  #
  #- name: Enable logging
  #  iptables_raw:
  #    name: enable_logging
  #    weight: 99
  #    keep_unmanaged: "{{ iptables_keep_unmanaged }}"
  #    rules: "{{ iptables_rules_logging }}"
  #  when: iptables_enable_logging
